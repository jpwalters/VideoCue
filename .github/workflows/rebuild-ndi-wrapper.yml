name: Rebuild NDI Wrapper (Auto)

on:
  push:
    paths:
      - 'videocue/ndi_wrapper/src/**'
      - 'videocue/ndi_wrapper/CMakeLists.txt'
      - '.github/workflows/rebuild-ndi-wrapper.yml'
    branches:
      - main
      - develop
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  rebuild-ndi:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install CMake
        run: |
          choco install cmake -y
      
      - name: Download NDI SDK
        run: |
          Write-Host "Checking for NDI SDK..."
          
          # Check if NDI SDK exists (on self-hosted runner)
          if (Test-Path "C:\Program Files\NDI\NDI 6 SDK") {
              Write-Host "[OK] NDI SDK found at C:\Program Files\NDI\NDI 6 SDK"
              $env:NDI_PATH = "C:\Program Files\NDI\NDI 6 SDK"
          } elseif (Test-Path "C:\NDI SDK 6") {
              Write-Host "[OK] NDI SDK found at C:\NDI SDK 6"
              $env:NDI_PATH = "C:\NDI SDK 6"
          } elseif (Test-Path "C:\Program Files\NDI SDK") {
              Write-Host "[OK] NDI SDK found at C:\Program Files\NDI SDK"
              $env:NDI_PATH = "C:\Program Files\NDI SDK"
          } else {
              # Download NDI SDK from NewTek
              Write-Host "[INFO] NDI SDK not found - downloading..."
              $ndiUrl = "https://get.ndi.video/e/1092312/SDK-NDI-SDK-NDI20620SDK-exe/lygzhs/2113259237/h/_EdCdLDbOZNnTUt1jV6oEEaEJSSk9VwcAM4agxRzmYs"
              $ndiInstallerPath = "$env:TEMP\NDI_SDK_installer.exe"
              
              try {
                  Write-Host "Downloading NDI SDK from $ndiUrl"
                  Invoke-WebRequest -Uri $ndiUrl -OutFile $ndiInstallerPath -TimeoutSec 300
                  Write-Host "[OK] NDI SDK downloaded to $ndiInstallerPath"
                  
                  # Run NDI SDK installer silently
                  Write-Host "Installing NDI SDK..."
                  & $ndiInstallerPath /S /D=C:\NDI` SDK` 6 | Out-Null
                  Start-Sleep -Seconds 5
                  
                  # Verify installation
                  if (Test-Path "C:\NDI SDK 6\Include\Processing.NDI.Lib.h") {
                      Write-Host "[OK] NDI SDK installed successfully"
                      $env:NDI_PATH = "C:\NDI SDK 6"
                  } else {
                      Write-Error "NDI SDK installation failed - headers not found"
                      exit 1
                  }
              } catch {
                  Write-Error "Failed to download/install NDI SDK: $_"
                  exit 1
              }
          }
          
          echo "NDI_PATH=$env:NDI_PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      
      - name: Install pybind11
        run: |
          python3.10 -m pip install pybind11
          python3.12 -m pip install pybind11
      
      - name: Build NDI wrapper (Python 3.10)
        run: |
          $env:Path = "C:\Program Files\CMake\bin;$env:Path"
          .\build_ndi_wrapper.ps1 -PythonVersion 3.10 -Verbose
      
      - name: Build NDI wrapper (Python 3.12)
        run: |
          $env:Path = "C:\Program Files\CMake\bin;$env:Path"
          .\build_ndi_wrapper.ps1 -PythonVersion 3.12 -Verbose
      
      - name: Check for changes
        id: check
        run: |
          git add videocue/ndi_wrapper/*.pyd || true
          
          if (git diff --cached --quiet) {
              Write-Host "No changes to .pyd files"
              echo "has_changes=false" >> $env:GITHUB_OUTPUT
          } else {
              Write-Host "Changes detected in .pyd files"
              echo "has_changes=true" >> $env:GITHUB_OUTPUT
              git diff --cached
          }
      
      - name: Commit and push changes
        if: steps.check.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add videocue/ndi_wrapper/*.pyd
          git commit -m "chore: rebuild NDI wrapper bindings" -m "" -m "Rebuilt from C++ source in videocue/ndi_wrapper/src/main.cpp" -m "Updated bindings for Python 3.10 and 3.12" -m "Triggered by ${{ github.event_name }} on ${{ github.ref }}"
          git push
      
      - name: Create Pull Request (if on develop)
        if: |
          steps.check.outputs.has_changes == 'true' &&
          github.ref == 'refs/heads/develop'
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "chore: rebuild NDI wrapper bindings"
          title: "Automated: Update NDI wrapper bindings"
          body: |
            ## Automated NDI Wrapper Rebuild
            
            C++ source changes detected. NDI Python bindings rebuilt from source.
            
            **Changes:**
            - `videocue/ndi_wrapper/src/main.cpp` updated
            - `.pyd` files regenerated for Python 3.10 and 3.12
            
            **Files changed:**
            - `videocue/ndi_wrapper/NDIlib.cp310-win_amd64.pyd`
            - `videocue/ndi_wrapper/NDIlib.cp312-win_amd64.pyd`
            
            This PR should be reviewed and merged to main before release.
          branch: automated/update-ndi-bindings
          delete-branch: true
          labels: "automation, ndi-wrapper"
